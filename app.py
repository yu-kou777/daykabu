import streamlit as st
import yfinance as yf
import pandas as pd
import requests  # ğŸ‘ˆ è¿½åŠ : Discordé€šä¿¡ç”¨
import json
from datetime import datetime, timedelta, timezone

# ==========================================
# âš™ï¸ è¨­å®š (ã“ã“ã«URLã‚’å…¥ã‚Œã¦ãã ã•ã„)
# ==========================================
DISCORD_WEBHOOK_URL ="https://discord.com/api/webhooks/1472281747000393902/Fbclh0R3R55w6ZnzhenJ24coaUPKy42abh3uPO-fRjfQulk9OwAq-Cf8cJQOe2U4SFme"

# ==========================================
# ğŸ“Š åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼šMACD, RSI, å¹³å‡è¶³
# ==========================================
def get_analysis(ticker, name):
    try:
        stock = yf.Ticker(ticker)
        # ãƒ‡ãƒ¼ã‚¿å–å¾—æœŸé–“ã‚’å°‘ã—é•·ã‚ã«ç¢ºä¿
        hist = stock.history(period="6mo")
        if len(hist) < 60: return None
        curr_price = int(hist["Close"].iloc[-1])

        # MACD
        ema12 = hist['Close'].ewm(span=12, adjust=False).mean()
        ema26 = hist['Close'].ewm(span=26, adjust=False).mean()
        macd = ema12 - ema26
        signal = macd.ewm(span=9, adjust=False).mean()
        
        # RSI
        delta = hist['Close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
        rsi_val = 100 - (100 / (1 + (gain / loss))).iloc[-1]

        # åè»¢ãƒ•ãƒ­ã‚¢äºˆæ¸¬ (ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰-2Ïƒä»˜è¿‘ã‚’æƒ³å®š)
        ma20 = hist['Close'].rolling(20).mean()
        std20 = hist['Close'].rolling(20).std()
        floor = max(int(ma20.iloc[-1] - (std20.iloc[-1] * 2)), int(hist['Low'].tail(60).min()))
        
        # MACDã®çŠ¶æ…‹åˆ¤å®š
        macd_val = macd.iloc[-1]
        sig_val = signal.iloc[-1]
        macd_status = "GC(ä¸Šæ˜‡)" if macd_val > sig_val else "DC(ä¸‹è½)"

        return {
            "ã‚³ãƒ¼ãƒ‰": ticker.replace(".T", ""), 
            "éŠ˜æŸ„å": name, 
            "ç¾åœ¨å€¤": curr_price,
            "RSI": round(rsi_val, 1), 
            "MACD": macd_status,
            "ãƒ•ãƒ­ã‚¢": floor, 
            "æŒ‡å€¤ç›®å®‰": int(floor * 1.01),
            "åˆ©ç¢ºç›®æ¨™": int(hist['High'].tail(25).max()), 
            "æåˆ‡ç›®å®‰": int(floor * 0.97)
        }
    except Exception as e:
        return None

# ==========================================
# ğŸ“¨ Discordé€ä¿¡æ©Ÿèƒ½ (æ–°è¦è¿½åŠ ï¼)
# ==========================================
def send_to_discord(data):
    if not DISCORD_WEBHOOK_URL.startswith("http"):
        st.error("âš ï¸ Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® `DISCORD_WEBHOOK_URL` ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚")
        return

    # è¦‹ã‚„ã™ã„ã€ŒåŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(Embed)ã€ã‚’ä½œæˆ
    payload = {
        "username": "æœ€å¼·æ ªã‚¹ã‚­ãƒ£ãƒŠãƒ¼ğŸ¦…",
        "embeds": [
            {
                "title": f"ğŸ“Š éŠ˜æŸ„åˆ†æ: {data['éŠ˜æŸ„å']} ({data['ã‚³ãƒ¼ãƒ‰']})",
                "description": f"**ç¾åœ¨å€¤: {data['ç¾åœ¨å€¤']}å††**\nMACD: {data['MACD']} | RSI: {data['RSI']}",
                "color": 3066993,  # ç·‘è‰²ã£ã½ã„ã‚«ãƒ©ãƒ¼
                "fields": [
                    {"name": "ğŸ›¡ï¸ åè»¢äºˆæƒ³ãƒ•ãƒ­ã‚¢", "value": f"{data['ãƒ•ãƒ­ã‚¢']}å††", "inline": True},
                    {"name": "ğŸ¯ åˆ©ç¢ºç›®æ¨™", "value": f"{data['åˆ©ç¢ºç›®æ¨™']}å††", "inline": True},
                    {"name": "ğŸ›‘ æåˆ‡ç›®å®‰", "value": f"{data['æåˆ‡ç›®å®‰']}å††", "inline": True},
                    {"name": "âš¡ æŒ‡å€¤ç›®å®‰", "value": f"**{data['æŒ‡å€¤ç›®å®‰']}å††**", "inline": False}
                ],
                "footer": {"text": "Generated by Hybrid-X Scanner"}
            }
        ]
    }
    
    try:
        response = requests.post(DISCORD_WEBHOOK_URL, json=payload)
        if response.status_code == 204:
            st.toast("âœ… Discordã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼", icon="ğŸ¦…")
        else:
            st.error(f"é€ä¿¡å¤±æ•—: {response.status_code}")
    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# ==========================================
# ğŸ¦… ç”»é¢è¡¨ç¤º
# ==========================================
st.set_page_config(page_title="æœ€å¼·æ ªã‚¹ã‚­ãƒ£ãƒŠãƒ¼", layout="wide")
st.title("ğŸ¦… æœ€å¼·æ ªã‚¹ã‚­ãƒ£ãƒŠãƒ¼ (Discordé€£æºç‰ˆ)")

# ç¿»è¨³ã‚¨ãƒ©ãƒ¼å›é¿
st.markdown('<meta name="google" content="notranslate">', unsafe_allow_html=True)

code_in = st.text_input("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ› (ä¾‹: 6701, 9984)", "").strip()

if code_in:
    # å…¨è§’æ•°å­—ãªã©ã‚’åŠè§’ã«å¤‰æ›ã—ãŸã‚Šã€.Tã‚’ã¤ã‘ã‚‹å‡¦ç†
    ticker_clean = code_in.replace(" ", "").replace("ã€€", "")
    full_c = ticker_clean + ".T" if ".T" not in ticker_clean and ticker_clean.isdigit() else ticker_clean
    
    with st.spinner('å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...'):
        res = get_analysis(full_c, ticker_clean)

    if res:
        # --- ãƒ¡ã‚¤ãƒ³æƒ…å ±ã®è¡¨ç¤º ---
        c1, c2, c3 = st.columns(3)
        with c1:
            st.metric("ç¾åœ¨å€¤", f"{res['ç¾åœ¨å€¤']}å††")
            st.info(f"ğŸ›¡ï¸ åè»¢äºˆæƒ³ãƒ•ãƒ­ã‚¢: {res['ãƒ•ãƒ­ã‚¢']}å††")
        with c2:
            st.success(f"âš¡ æŒ‡å€¤ç›®å®‰: {res['æŒ‡å€¤ç›®å®‰']}å††")
            st.write(f"ğŸ¯ åˆ©ç¢º: {res['åˆ©ç¢ºç›®æ¨™']}å†† / ğŸ›‘ æåˆ‡: {res['æåˆ‡ç›®å®‰']}å††")
        with c3:
            # RSIã®è‰²åˆ†ã‘
            rsi_color = "red" if res['RSI'] < 30 else ("blue" if res['RSI'] > 70 else "black")
            st.markdown(f"MACDçŠ¶æ…‹: **{res['MACD']}**")
            st.markdown(f"RSI(14): <span style='color:{rsi_color}; font-weight:bold;'>{res['RSI']}</span>", unsafe_allow_html=True)

        st.divider()

        # --- ğŸ‘‡ ã“ã“ãŒè¿½åŠ æ©Ÿèƒ½ï¼šé€šçŸ¥ãƒœã‚¿ãƒ³ ---
        col_btn, col_void = st.columns([1, 4])
        with col_btn:
            if st.button('ğŸ¦… Discordã«é€šçŸ¥ã‚’é€ã‚‹'):
                send_to_discord(res)
    else:
        st.error("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
